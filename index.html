<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Admin Panel</title>
    <style>
        :root {
            --primary-color: #4a69bd; --secondary-color: #1e3799; --background-color: #f5f7fa;
            --sidebar-bg: #2c3e50; --sidebar-text: #ecf0f1; --sidebar-hover: #34495e;
            --text-color: #333; --card-bg: #ffffff; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --danger-color: #e74c3c; --danger-hover: #c0392b; --warning-color: #f39c12; --warning-hover: #e67e22;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        .admin-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid var(--sidebar-hover); }
        .sidebar-menu { list-style: none; padding: 20px 0; margin: 0; flex-grow: 1; }
        .sidebar-menu li a { display: flex; align-items: center; color: var(--sidebar-text); text-decoration: none; padding: 15px 20px; transition: background-color: 0.3s; border-left: 4px solid transparent; }
        .sidebar-menu li a:hover { background-color: var(--sidebar-hover); }
        .sidebar-menu li a.active { background-color: var(--primary-color); border-left: 4px solid var(--sidebar-text); font-weight: bold; }
        .main-content { flex-grow: 1; padding: 25px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h1 { margin: 0; font-size: 2rem; color: var(--secondary-color); }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background-color: var(--card-bg); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background-color: 0.2s; }
        .btn:hover { background-color: var(--secondary-color); }
        .btn.secondary { background: #7f8c8d; }
        .btn.secondary:hover { background: #95a5a6; }
        .btn-sm { padding: 6px 12px; font-size: 0.9rem; }
        .btn-warning { background-color: var(--warning-color); }
        .btn-warning:hover { background-color: var(--warning-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table thead tr { background-color: var(--primary-color); color: #ffffff; text-align: left; }
        .styled-table th, .styled-table td { padding: 12px 15px; }
        .styled-table tbody tr { border-bottom: 1px solid #dddddd; }
        .styled-table tbody tr:hover { background-color: #f5f5f5; }
        .action-buttons button { margin-right: 5px; }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: 8px; width: 80%; max-width: 500px; animation: modalopen 0.4s; }
        @keyframes modalopen { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 1.2rem; }
        .stat-card p { margin: 0; font-size: 2.5rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="card" style="width: 400px;">
            <h2>Admin Login</h2>
            <div id="login-error" style="color: var(--danger-color); margin-bottom: 10px;"></div>
            <form onsubmit="loginUser(event)">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="admin-container" style="display: none;">
        <nav class="sidebar">
            <div class="sidebar-header">ERP System</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showPage('dashboard', this)">Dashboard</a></li>
                <li><a href="#" onclick="showPage('bom-update', this)">BOM Update</a></li>
                <li><a href="#" onclick="showPage('user-management', this)">User Management</a></li>
                <li><a href="#" onclick="showPage('master-report', this)">Master Report</a></li>
                <li><a href="#" onclick="showPage('packing-send-report', this)">Packing Send Report</a></li>
                <li><a href="#" onclick="logoutUser()">Logout</a></li>
            </ul>
        </nav>
        <main class="main-content">
            <div id="dashboard" class="page-content">
                <div class="header"><h1>Dashboard</h1></div>
                <div class="stat-cards">
                    <div class="stat-card"><h3>Total Target (Qty)</h3><p id="total-target-qty">0</p></div>
                    <div class="stat-card"><h3>Total Users</h3><p id="total-users">0</p></div>
                    <div class="stat-card"><h3>Total Production</h3><p id="total-production">0</p></div>
                    <div class="stat-card"><h3>Total Failures</h3><p id="total-fail">0</p></div>
                </div>
            </div>
            <div id="bom-update" class="page-content">
                <div class="header"><h1>BOM (Bill of Materials) Update</h1></div>
                <div class="card">
                    <form id="bom-form" onsubmit="saveBOM(event)">
                        <div class="form-grid">
                            <div class="form-group"><label for="model-name">Model Name</label><input type="text" id="model-name" required></div>
                            <div class="form-group"><label for="batch-no">Batch Number</label><input type="text" id="batch-no" required></div>
                            <div class="form-group"><label for="material-name">Material Name</label><input type="text" id="material-name" required></div>
                            <div class="form-group"><label for="color">Color</label><input type="text" id="color" required></div>
                            <div class="form-group"><label for="import-qty">Imported Quantity</label><input type="number" id="import-qty" min="0" required></div>
                            <div class="form-group"><label for="target-qty">Target Quantity</label><input type="number" id="target-qty" min="1" required></div>
                        </div>
                        <button type="submit" class="btn">Save BOM</button>
                    </form>
                </div>
            </div>
            <div id="user-management" class="page-content">
                <div class="header"><h1>User Management</h1></div>
                <div class="card">
                    <button id="addUserBtn" class="btn" style="margin-bottom: 20px;">Add New User</button>
                    <table class="styled-table">
                        <thead><tr><th>Email</th><th>Role</th><th>Action</th></tr></thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="master-report" class="page-content">
                 <div class="header"><h1>Master Report</h1></div>
                <div class="card">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Model Name</th>
                                <th>Batch No.</th>
                                <th>Color</th>
                                <th>Target</th>
                                <th>In-Hand</th>
                                <th>Sent to Packing</th>
                                <th>Total Fail</th>
                                <th>Remaining</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="packing-send-report" class="page-content">
                <div class="header"><h1>Packing Send Report</h1></div>
                <div class="card">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Model Name</th>
                                <th>Batch No.</th>
                                <th>Color</th>
                                <th>Quantity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="packing-report-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addUserModal')">&times;</span>
            <h2>Create New User</h2>
             <div id="modal-error" style="color: var(--danger-color); margin-bottom: 10px;"></div>
            <form id="addUserForm" onsubmit="createNewUser(event)">
                <div class="form-group"><label for="user-email">Email</label><input type="email" id="user-email" required></div>
                <div class="form-group"><label for="user-password">Password</label><input type="password" id="user-password" required></div>
                <div class="form-group"><label for="user-role">Role</label><select id="user-role" required><option value="user">User</option><option value="admin">Admin</option></select></div>
                <button type="submit" class="btn">Create User</button>
            </form>
        </div>
    </div>
    
    <div id="editMaterialModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editMaterialModal')">&times;</span>
            <h2>Edit Product Data</h2>
            <form id="editMaterialForm" onsubmit="updateMaterial(event)">
                <input type="hidden" id="edit-material-id">
                <div class="form-grid">
                    <div class="form-group"><label for="edit-model-name">Model Name</label><input type="text" id="edit-model-name" required></div>
                    <div class="form-group"><label for="edit-batch-no">Batch Number</label><input type="text" id="edit-batch-no" required></div>
                    <div class="form-group"><label for="edit-color">Color</label><input type="text" id="edit-color" required></div>
                    <div class="form-group"><label for="edit-target-qty">Target Quantity</label><input type="number" id="edit-target-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-in-hand-qty">In-Hand Quantity</label><input type="number" id="edit-in-hand-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-packing-sent-qty">Sent to Packing Qty</label><input type="number" id="edit-packing-sent-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-fail-qty">Production Fail Qty</label><input type="number" id="edit-fail-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-faulty-qty">Packing Fail Qty</label><input type="number" id="edit-faulty-qty" min="0" required></div>
                </div>
                <button type="submit" class="btn">Update Data</button>
            </form>
        </div>
    </div>

    <div id="editPackingSendModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editPackingSendModal')">&times;</span>
            <h2>Edit Packing Send Entry</h2>
            <form id="editPackingSendForm" onsubmit="updatePackingSendEntry(event)">
                <input type="hidden" id="edit-packing-send-id">
                <div class="form-group"><label for="edit-packing-qty">Sent Quantity</label><input type="number" id="edit-packing-qty" min="1" required></div>
                <button type="submit" class="btn">Update</button>
            </form>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC1gLXDKHtkMV2s5ZsRlrHF8MiuP_pQnCo",
            authDomain: "erp-22158.firebaseapp.com",
            databaseURL: "https://erp-22158-default-rtdb.firebaseio.com",
            projectId: "erp-22158",
            storageBucket: "erp-22158.appspot.com",
            messagingSenderId: "87466207491",
            appId: "1:87466207491:web:e1edbb1910f59cb3cf6136",
            measurementId: "G-651LD359N7"
        };
        
        const mainApp = firebase.initializeApp(firebaseConfig);
        const auth = mainApp.auth();
        const db = mainApp.firestore();
        const secondaryApp = firebase.initializeApp(firebaseConfig, 'userCreationApp');
        
        let allMaterialsData = [];
        let allPackingSendData = [];

        function showPage(pageId, element) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(element) {
                document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                element.classList.add('active');
            }
            if (pageId === 'dashboard') loadDashboardData();
            if (pageId === 'user-management') fetchUsers();
            if (pageId === 'master-report') fetchAllMaterialsAndRenderReport();
            if (pageId === 'packing-send-report') fetchPackingSendReport();
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                checkUserRoleAndShowPanel(user.uid);
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        // ===================================================================
        // ===== START: DEBUGGING FUNCTION ===================================
        // ===================================================================
        // This function will print messages to the browser console to help find the error.
        async function checkUserRoleAndShowPanel(uid) {
             try {
                console.log("Step 1: Checking role for user with UID:", uid);
                
                const userDoc = await db.collection('users').doc(uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log("Step 2: User document found in Firestore.");
                    console.log("Step 3: User Data:", userData);
                    console.log("Step 4: ROLE FOUND is:", userData.role);

                    if (userData.role === 'admin') {
                        console.log("Step 5: SUCCESS! Role is 'admin'. Granting access.");
                        
                        document.getElementById('login-page').style.display = 'none';
                        document.getElementById('admin-panel').style.display = 'flex';
                        initializeModalListeners();
                        showPage('dashboard', document.querySelector('.sidebar-menu a'));
                    } else {
                        console.error("Step 5: FAILED! Role is NOT 'admin'. Role found:", userData.role);
                        alert("Permission Denied. Your role is: " + (userData.role || "Not Assigned"));
                        logoutUser();
                    }
                } else {
                    console.error("Step 2: FAILED! No user document found in Firestore for this UID.");
                    alert("You do not have a user profile in the database. Please contact support.");
                    logoutUser();
                }
            } catch (error) {
                console.error("CRITICAL ERROR while checking user role:", error);
                alert("An error occurred while checking permissions. Check the browser console (F12) for details.");
                logoutUser();
            }
        }
        // ===================================================================
        // ===== END: DEBUGGING FUNCTION =====================================
        // ===================================================================
        
        function loginUser(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = '';
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Login Error:", error);
                    errorDiv.textContent = 'Incorrect email or password.';
                });
        }

        function logoutUser() { 
            auth.signOut(); 
        }

        async function createNewUser(event) {
            event.preventDefault();
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            const errorDiv = document.getElementById('modal-error');
            errorDiv.textContent = '';
            
            try {
                const userCredential = await secondaryApp.auth().createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(userCredential.user.uid).set({ email, role });
                await secondaryApp.auth().signOut();
                alert('User created successfully!');
                closeModal('addUserModal');
                fetchUsers();
            } catch (error) {
                errorDiv.textContent = error.message;
                await secondaryApp.auth().signOut();
            }
        }

        async function fetchUsers() {
            try {
                const snapshot = await db.collection('users').get();
                const userTableBody = document.getElementById('user-table-body');
                userTableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    userTableBody.innerHTML += `<tr><td>${user.email}</td><td>${user.role}</td><td><button class="btn btn-sm btn-danger" onclick="deleteUser('${doc.id}', '${user.email}')">Delete</button></td></tr>`;
                });
            } catch(error){
                console.error("Error fetching users:", error);
            }
        }

        async function deleteUser(docId, email) {
            if (confirm(`Are you sure you want to delete the user "${email}"?`)) {
                db.collection('users').doc(docId).delete().then(() => {
                    alert("User deleted from database successfully.");
                    fetchUsers();
                });
            }
        }
        
        async function saveBOM(event) {
            event.preventDefault();
            const bomData = {
                modelName: document.getElementById('model-name').value,
                batchNo: document.getElementById('batch-no').value,
                materialName: document.getElementById('material-name').value,
                color: document.getElementById('color').value,
                importQty: Number(document.getElementById('import-qty').value),
                targetQty: Number(document.getElementById('target-qty').value),
                inHandQty: 0,
                packingSentQty: 0,
                faultyQty: 0,
                failQty: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try {
                await db.collection('materials').add(bomData);
                alert('BOM saved successfully!');
                document.getElementById('bom-form').reset();
            } catch (error) {
                alert('An error occurred: ' + error.message);
            }
        }
        
        async function fetchAllMaterialsAndRenderReport() {
            const reportTableBody = document.getElementById('report-table-body');
            reportTableBody.innerHTML = `<tr><td colspan="9">Loading...</td></tr>`;
            try {
                const snapshot = await db.collection('materials').orderBy('createdAt', 'desc').get();
                allMaterialsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMasterReport(allMaterialsData);
            } catch (error) {
                console.error("Error loading master report:", error);
            }
        }

        function renderMasterReport(data) {
            const reportTableBody = document.getElementById('report-table-body');
            let tableHtml = '';
            if (data.length === 0) {
                 reportTableBody.innerHTML = `<tr><td colspan="9">No data found.</td></tr>`;
                 return;
            }
            data.forEach(item => {
                const target = item.targetQty || 0;
                const inHand = item.inHandQty || 0;
                const packingSent = item.packingSentQty || 0;
                const totalFail = (item.faultyQty || 0) + (item.failQty || 0);
                const achievement = inHand + packingSent;
                const remaining = target - achievement;
                tableHtml += `
                    <tr>
                        <td>${item.modelName}</td>
                        <td>${item.batchNo || 'N/A'}</td>
                        <td>${item.color}</td>
                        <td>${target}</td>
                        <td>${inHand}</td>
                        <td>${packingSent}</td>
                        <td>${totalFail}</td>
                        <td>${remaining > 0 ? remaining : 0}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning" onclick="openEditMaterialModal('${item.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMaterialEntry('${item.id}', '${item.modelName} - ${item.batchNo}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            reportTableBody.innerHTML = tableHtml;
        }
        
        async function deleteMaterialEntry(docId, modelInfo) {
            if (confirm(`Are you sure you want to permanently delete "${modelInfo}"?`)) {
                db.collection('materials').doc(docId).delete()
                    .then(() => {
                        alert('Entry deleted successfully!');
                        fetchAllMaterialsAndRenderReport();
                    })
                    .catch((error) => alert('Error deleting entry: ' + error));
            }
        }

        function openEditMaterialModal(docId) {
            const material = allMaterialsData.find(m => m.id === docId);
            if (material) {
                document.getElementById('edit-material-id').value = docId;
                document.getElementById('edit-model-name').value = material.modelName;
                document.getElementById('edit-batch-no').value = material.batchNo;
                document.getElementById('edit-color').value = material.color;
                document.getElementById('edit-target-qty').value = material.targetQty || 0;
                document.getElementById('edit-in-hand-qty').value = material.inHandQty || 0;
                document.getElementById('edit-packing-sent-qty').value = material.packingSentQty || 0;
                document.getElementById('edit-fail-qty').value = material.failQty || 0;
                document.getElementById('edit-faulty-qty').value = material.faultyQty || 0;
                document.getElementById('editMaterialModal').style.display = 'block';
            }
        }
        
        async function updateMaterial(event) {
            event.preventDefault();
            const docId = document.getElementById('edit-material-id').value;
            const updatedData = {
                modelName: document.getElementById('edit-model-name').value,
                batchNo: document.getElementById('edit-batch-no').value,
                color: document.getElementById('edit-color').value,
                targetQty: Number(document.getElementById('edit-target-qty').value),
                inHandQty: Number(document.getElementById('edit-in-hand-qty').value),
                packingSentQty: Number(document.getElementById('edit-packing-sent-qty').value),
                failQty: Number(document.getElementById('edit-fail-qty').value),
                faultyQty: Number(document.getElementById('edit-faulty-qty').value),
            };
            try {
                await db.collection('materials').doc(docId).update(updatedData);
                alert('Product data updated successfully!');
                closeModal('editMaterialModal');
                fetchAllMaterialsAndRenderReport();
                loadDashboardData();
            } catch (error) {
                alert('Failed to update: ' + error.message);
            }
        }
        
        async function fetchPackingSendReport() {
            const reportTableBody = document.getElementById('packing-report-table-body');
            reportTableBody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;
            try {
                const snapshot = await db.collection('packing_sends').orderBy('sentAt', 'desc').get();
                allPackingSendData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPackingSendReport(allPackingSendData);
            } catch (error) {
                console.error("Error loading packing send report:", error);
                reportTableBody.innerHTML = `<tr><td colspan="6">Failed to load data.</td></tr>`;
            }
        }
        
        function renderPackingSendReport(data) {
            const reportTableBody = document.getElementById('packing-report-table-body');
            let tableHtml = '';
            if (data.length === 0) {
                 reportTableBody.innerHTML = `<tr><td colspan="6">No data found.</td></tr>`;
                 return;
            }
            data.forEach(item => {
                const sentDate = item.sentAt ? item.sentAt.toDate().toLocaleString('en-US') : 'N/A';
                tableHtml += `
                    <tr>
                        <td>${sentDate}</td>
                        <td>${item.modelName}</td>
                        <td>${item.batchNo || 'N/A'}</td>
                        <td>${item.color}</td>
                        <td>${item.quantity}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-warning" onclick="openEditPackingSendModal('${item.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePackingSendEntry('${item.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            reportTableBody.innerHTML = tableHtml;
        }

        function openEditPackingSendModal(docId) {
            const entry = allPackingSendData.find(p => p.id === docId);
            if (entry) {
                document.getElementById('edit-packing-send-id').value = docId;
                document.getElementById('edit-packing-qty').value = entry.quantity;
                document.getElementById('editPackingSendModal').style.display = 'block';
            }
        }

        async function updatePackingSendEntry(event) {
            event.preventDefault();
            const docId = document.getElementById('edit-packing-send-id').value;
            const newQuantity = Number(document.getElementById('edit-packing-qty').value);
            try {
                await db.collection('packing_sends').doc(docId).update({ quantity: newQuantity });
                alert('Entry updated successfully!');
                closeModal('editPackingSendModal');
                fetchPackingSendReport();
            } catch (error) {
                alert('Failed to update entry: ' + error.message);
            }
        }
        
        async function deletePackingSendEntry(docId) {
            if (confirm("Are you sure you want to permanently delete this entry?")) {
                try {
                    await db.collection('packing_sends').doc(docId).delete();
                    alert("Entry deleted successfully.");
                    fetchPackingSendReport();
                } catch (error) {
                    alert("Failed to delete entry: " + error.message);
                }
            }
        }

        async function loadDashboardData() {
            try {
                const usersPromise = db.collection('users').get();
                const materialsPromise = db.collection('materials').get();
                
                const [usersSnapshot, materialsSnapshot] = await Promise.all([usersPromise, materialsPromise]);
                
                let totalTargetQty = 0;
                let totalProduction = 0, totalFail = 0;
                
                materialsSnapshot.forEach(doc => {
                    const data = doc.data();
                    totalTargetQty += (data.targetQty || 0);
                    totalProduction += (data.inHandQty || 0) + (data.packingSentQty || 0);
                    totalFail += (data.faultyQty || 0) + (data.failQty || 0);
                });
                
                document.getElementById('total-users').textContent = usersSnapshot.size;
                document.getElementById('total-target-qty').textContent = totalTargetQty;
                document.getElementById('total-production').textContent = totalProduction;
                document.getElementById('total-fail').textContent = totalFail;
            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function initializeModalListeners() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const span = modal.querySelector(".close-button");
                if (span) {
                    span.onclick = () => { modal.style.display = "none"; };
                }
            });
            window.onclick = (event) => {
                modals.forEach(modal => {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                });
            };
            const addUserBtn = document.getElementById("addUserBtn");
            if(addUserBtn) {
                addUserBtn.onclick = () => {
                    document.getElementById('addUserModal').style.display = "block";
                    document.getElementById('addUserForm').reset();
                    document.getElementById('modal-error').textContent = '';
                };
            }
        }
    </script>
</body>
</html>
