<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Admin Panel</title>
    <style>
        :root {
            --primary-color: #4a69bd; --secondary-color: #1e3799; --background-color: #f5f7fa;
            --sidebar-bg: #2c3e50; --sidebar-text: #ecf0f1; --sidebar-hover: #34495e;
            --text-color: #333; --card-bg: #ffffff; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --danger-color: #e74c3c; --danger-hover: #c0392b; --warning-color: #f39c12; --warning-hover: #e67e22;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); }
        .admin-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid var(--sidebar-hover); }
        .sidebar-menu { list-style: none; padding: 20px 0; margin: 0; flex-grow: 1; }
        .sidebar-menu li a { display: flex; align-items: center; color: var(--sidebar-text); text-decoration: none; padding: 15px 20px; transition: background-color 0.3s; border-left: 4px solid transparent; }
        .sidebar-menu li a:hover { background-color: var(--sidebar-hover); }
        .sidebar-menu li a.active { background-color: var(--primary-color); border-left: 4px solid var(--sidebar-text); font-weight: bold; }
        .main-content { flex-grow: 1; padding: 25px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h1 { margin: 0; font-size: 2rem; color: var(--secondary-color); }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .card { background-color: var(--card-bg); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .btn-sm { padding: 6px 12px; font-size: 0.9rem; }
        .btn-warning { background-color: var(--warning-color); }
        .btn-danger { background-color: var(--danger-color); }
        .styled-table { width: 100%; border-collapse: collapse; }
        .styled-table thead tr { background-color: var(--primary-color); color: #ffffff; text-align: left; }
        .styled-table th, .styled-table td { padding: 12px 15px; border-bottom: 1px solid #dddddd; }
        .action-buttons button { margin-right: 5px; }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border-radius: 8px; width: 80%; max-width: 700px; animation: modalopen 0.4s; }
        @keyframes modalopen { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .permission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .permission-item { display: flex; align-items: center; margin-bottom: 8px; }
        .permission-item input { width: auto; margin-right: 10px; }
        .permission-item label { margin-bottom: 0; }
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 1.2rem; }
        .stat-card p { margin: 0; font-size: 2.5rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="card" style="width: 400px;">
            <h2>Admin Login</h2>
            <div id="login-error" style="color: var(--danger-color); margin-bottom: 10px;"></div>
            <form onsubmit="loginUser(event)">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div>
                <button type="submit" class="btn" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="admin-container" style="display: none;">
        <nav class="sidebar">
            <div class="sidebar-header">ERP System</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showPage('dashboard', this)">Dashboard</a></li>
                <li><a href="#" onclick="showPage('bom-update', this)">BOM Update</a></li>
                <li><a href="#" onclick="showPage('user-management', this)">User Management</a></li>
                <li><a href="#" onclick="showPage('master-report', this)">Master Report</a></li>
                <li><a href="#" onclick="showPage('packing-send-report', this)">Packing Send Report</a></li>
                <li><a href="#" onclick="logoutUser()">Logout</a></li>
            </ul>
        </nav>
        <main class="main-content">
            <div id="dashboard" class="page-content">
                <div class="header"><h1>Dashboard</h1></div>
                <div class="stat-cards">
                    <div class="stat-card"><h3>Total Target (Qty)</h3><p id="total-target-qty">0</p></div>
                    <div class="stat-card"><h3>Total Users</h3><p id="total-users">0</p></div>
                    <div class="stat-card"><h3>Total Production</h3><p id="total-production">0</p></div>
                    <div class="stat-card"><h3>Total Failures</h3><p id="total-fail">0</p></div>
                </div>
            </div>
            <div id="bom-update" class="page-content">
                <div class="header"><h1>BOM (Bill of Materials) Update</h1></div>
                <div class="card">
                    <form id="bom-form" onsubmit="saveBOM(event)">
                        <div class="form-grid">
                            <div class="form-group"><label for="model-name">Model Name</label><input type="text" id="model-name" required></div>
                            <div class="form-group"><label for="batch-no">Batch Number</label><input type="text" id="batch-no" required></div>
                            <div class="form-group"><label for="material-name">Material Name</label><input type="text" id="material-name" required></div>
                            <div class="form-group"><label for="color">Color</label><input type="text" id="color" required></div>
                            <div class="form-group"><label for="import-qty">Imported Quantity</label><input type="number" id="import-qty" min="0" required></div>
                            <div class="form-group"><label for="target-qty">Target Quantity</label><input type="number" id="target-qty" min="1" required></div>
                        </div>
                        <button type="submit" class="btn">Save BOM</button>
                    </form>
                </div>
            </div>
            <div id="user-management" class="page-content">
                <div class="header"><h1>User Management</h1></div>
                <div class="card">
                    <button id="addUserBtn" class="btn" style="margin-bottom: 20px;">Add New User</button>
                    <table class="styled-table">
                        <thead><tr><th>Email</th><th>Actions</th></tr></thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="master-report" class="page-content">
                 <div class="header"><h1>Master Report</h1></div>
                <div class="card">
                    <table class="styled-table">
                        <thead><tr><th>Model Name</th><th>Batch No.</th><th>Color</th><th>Target</th><th>In-Hand</th><th>Sent to Packing</th><th>Total Fail</th><th>Remaining</th><th>Action</th></tr></thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="packing-send-report" class="page-content">
                <div class="header"><h1>Packing Send Report</h1></div>
                <div class="card">
                    <table class="styled-table">
                        <thead><tr><th>Date</th><th>Model Name</th><th>Batch No.</th><th>Color</th><th>Quantity</th><th>Action</th></tr></thead>
                        <tbody id="packing-report-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('userModal')">&times;</span>
            <h2 id="user-modal-title">Add New User</h2>
             <div id="modal-error" style="color: var(--danger-color); margin-bottom: 10px;"></div>
            <form id="userForm" onsubmit="saveUser(event)">
                <input type="hidden" id="user-id">
                <div class="form-group"><label for="user-email">Email</label><input type="email" id="user-email" required></div>
                <div class="form-group" id="password-group"><label for="user-password">Password</label><input type="password" id="user-password"></div>
                <hr>
                <h4>Permissions</h4>
                <div class="permission-grid">
                    <div class="permission-item"><input type="checkbox" id="perm-viewDashboard"><label for="perm-viewDashboard">View Dashboard</label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-canEnterProduction"><label for="perm-canEnterProduction">Production Entry</label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-canEnterProductionFail"><label for="perm-canEnterProductionFail">Production Fail</label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-canEnterPackingFail"><label for="perm-canEnterPackingFail">Packing Fail</label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-canSendToPacking"><label for="perm-canSendToPacking">Send to Packing</label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-canReturnFromPacking"><label for="perm-canReturnFromPacking">Packing Return</label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-viewMasterReport"><label for="perm-viewMasterReport">View Master Report</label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-viewPackingReport"><label for="perm-viewPackingReport">View Packing Report</label></div>
                    <hr style="grid-column: 1 / -1;">
                    <div class="permission-item"><input type="checkbox" id="perm-manageBOM"><label for="perm-manageBOM"><b>Manage BOM (Admin)</b></label></div>
                    <div class="permission-item"><input type="checkbox" id="perm-manageUsers"><label for="perm-manageUsers"><b>Manage Users (Admin)</b></label></div>
                </div>
                <br>
                <button type="submit" class="btn">Save User</button>
            </form>
        </div>
    </div>
    
    <div id="editMaterialModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editMaterialModal')">&times;</span>
            <h2>Edit Product Data</h2>
            <form id="editMaterialForm" onsubmit="updateMaterial(event)">
                <input type="hidden" id="edit-material-id">
                <div class="form-grid">
                    <div class="form-group"><label for="edit-model-name">Model Name</label><input type="text" id="edit-model-name" required></div>
                    <div class="form-group"><label for="edit-batch-no">Batch Number</label><input type="text" id="edit-batch-no" required></div>
                    <div class="form-group"><label for="edit-color">Color</label><input type="text" id="edit-color" required></div>
                    <div class="form-group"><label for="edit-target-qty">Target Quantity</label><input type="number" id="edit-target-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-in-hand-qty">In-Hand Quantity</label><input type="number" id="edit-in-hand-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-packing-sent-qty">Sent to Packing Qty</label><input type="number" id="edit-packing-sent-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-fail-qty">Production Fail Qty</label><input type="number" id="edit-fail-qty" min="0" required></div>
                    <div class="form-group"><label for="edit-faulty-qty">Packing Fail Qty</label><input type="number" id="edit-faulty-qty" min="0" required></div>
                </div>
                <button type="submit" class="btn">Update Data</button>
            </form>
        </div>
    </div>

    <div id="editPackingSendModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editPackingSendModal')">&times;</span>
            <h2>Edit Packing Send Entry</h2>
            <form id="editPackingSendForm" onsubmit="updatePackingSendEntry(event)">
                <input type="hidden" id="edit-packing-send-id">
                <div class="form-group"><label for="edit-packing-qty">Sent Quantity</label><input type="number" id="edit-packing-qty" min="1" required></div>
                <button type="submit" class="btn">Update</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyC1gLXDKHtkMV2s5ZsRlrHF8MiuP_pQnCo", authDomain: "erp-22158.firebaseapp.com", projectId: "erp-22158", storageBucket: "erp-22158.appspot.com", messagingSenderId: "87466207491", appId: "1:87466207491:web:e1edbb1910f59cb3cf6136" };
        const mainApp = firebase.initializeApp(firebaseConfig);
        const auth = mainApp.auth();
        const db = mainApp.firestore();
        const secondaryApp = firebase.initializeApp(firebaseConfig, 'userCreationApp');
        
        const allPermissionKeys = ['viewDashboard', 'canEnterProduction', 'canEnterProductionFail', 'canEnterPackingFail', 'canSendToPacking', 'canReturnFromPacking', 'viewMasterReport', 'viewPackingReport', 'manageBOM', 'manageUsers'];
        let allMaterialsData = [], allPackingSendData = [];

        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data()) {
                        const userData = doc.data();
                        if (userData.role === 'admin' || (userData.permissions && userData.permissions.manageUsers)) {
                            document.getElementById('login-page').style.display = 'none';
                            document.getElementById('admin-panel').style.display = 'flex';
                            showPage('dashboard', document.querySelector('.sidebar-menu a'));
                            initializeModalListeners();
                        } else {
                            alert("Access Denied. You do not have administrator permissions.");
                            logoutUser();
                        }
                    } else {
                         alert("Your user profile was not found. Please contact an admin.");
                         logoutUser();
                    }
                });
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        function loginUser(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => document.getElementById('login-error').textContent = 'Incorrect email or password.');
        }

        function logoutUser() { auth.signOut(); }

        function showPage(pageId, el) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            if(el) el.classList.add('active');
            if (pageId === 'dashboard') loadDashboardData();
            if (pageId === 'user-management') fetchUsers();
            if (pageId === 'master-report') fetchAllMaterialsAndRenderReport();
            if (pageId === 'packing-send-report') fetchPackingSendReport();
        }
        
        async function fetchUsers() {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '<tr><td colspan="2">Loading users...</td></tr>';
            const snapshot = await db.collection('users').get();
            tbody.innerHTML = '';
            snapshot.forEach(doc => {
                tbody.innerHTML += `<tr><td>${doc.data().email}</td><td class="action-buttons"><button class="btn-sm btn-warning" onclick="openUserModal(true, '${doc.id}')">Edit Permissions</button> <button class="btn-sm btn-danger" onclick="deleteUser('${doc.id}')">Delete</button></td></tr>`;
            });
        }
        
        function openUserModal(isEdit = false, docId = null) {
            document.getElementById('userForm').reset();
            const modal = document.getElementById('userModal');
            const passwordInput = document.getElementById('user-password');
            document.getElementById('modal-error').textContent = '';
            if (isEdit) {
                document.getElementById('user-modal-title').textContent = 'Edit User Permissions';
                document.getElementById('password-group').style.display = 'none';
                passwordInput.required = false; // Password not required for editing
                document.getElementById('user-email').readOnly = true;
                document.getElementById('user-id').value = docId;
                db.collection('users').doc(docId).get().then(doc => {
                    if (doc.exists) {
                        const user = doc.data();
                        document.getElementById('user-email').value = user.email;
                        allPermissionKeys.forEach(key => {
                            const el = document.getElementById(`perm-${key}`);
                            if(el) el.checked = !!(user.permissions && user.permissions[key]);
                        });
                    }
                });
            } else {
                document.getElementById('user-modal-title').textContent = 'Add New User';
                document.getElementById('password-group').style.display = 'block';
                passwordInput.required = true; // Password is required for new user
                document.getElementById('user-email').readOnly = false;
                document.getElementById('user-id').value = '';
            }
            modal.style.display = 'block';
        }
        
        async function saveUser(event) {
            event.preventDefault();
            const userId = document.getElementById('user-id').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const errorDiv = document.getElementById('modal-error');
            const permissions = {};
            allPermissionKeys.forEach(key => {
                const el = document.getElementById(`perm-${key}`);
                if(el) permissions[key] = el.checked;
            });
            const role = (permissions.manageUsers || permissions.manageBOM) ? 'admin' : 'user';
            try {
                if (userId) {
                    await db.collection('users').doc(userId).set({ permissions, role }, { merge: true });
                    alert('User permissions updated successfully!');
                } else {
                    const cred = await secondaryApp.auth().createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(cred.user.uid).set({ email, permissions, role });
                    await secondaryApp.auth().signOut();
                    alert('User created successfully!');
                }
                closeModal('userModal');
                fetchUsers();
            } catch (error) { errorDiv.textContent = error.message; }
        }

        async function deleteUser(docId) { if (confirm(`Are you sure you want to delete this user?`)) { await db.collection('users').doc(docId).delete(); fetchUsers(); }}
        
        async function saveBOM(event) {
            event.preventDefault();
            const bomData = { modelName: document.getElementById('model-name').value, batchNo: document.getElementById('batch-no').value, materialName: document.getElementById('material-name').value, color: document.getElementById('color').value, importQty: Number(document.getElementById('import-qty').value), targetQty: Number(document.getElementById('target-qty').value), inHandQty: 0, packingSentQty: 0, faultyQty: 0, failQty: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
            try {
                await db.collection('materials').add(bomData);
                alert('BOM saved successfully!');
                document.getElementById('bom-form').reset();
            } catch (error) { alert('An error occurred: ' + error.message); }
        }
        
        async function fetchAllMaterialsAndRenderReport() {
            const reportTableBody = document.getElementById('report-table-body');
            reportTableBody.innerHTML = `<tr><td colspan="9">Loading...</td></tr>`;
            try {
                const snapshot = await db.collection('materials').orderBy('createdAt', 'desc').get();
                allMaterialsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMasterReport(allMaterialsData);
            } catch (error) { console.error("Error loading master report:", error); }
        }

        function renderMasterReport(data) {
            const reportTableBody = document.getElementById('report-table-body');
            let tableHtml = '';
            if (data.length === 0) { reportTableBody.innerHTML = `<tr><td colspan="9">No data found.</td></tr>`; return; }
            data.forEach(item => {
                const target = item.targetQty || 0, inHand = item.inHandQty || 0, packingSent = item.packingSentQty || 0, totalFail = (item.faultyQty || 0) + (item.failQty || 0), achievement = inHand + packingSent, remaining = target - achievement;
                tableHtml += `<tr><td>${item.modelName}</td><td>${item.batchNo || 'N/A'}</td><td>${item.color}</td><td>${target}</td><td>${inHand}</td><td>${packingSent}</td><td>${totalFail}</td><td>${remaining > 0 ? remaining : 0}</td><td class="action-buttons"><button class="btn btn-sm btn-warning" onclick="openEditMaterialModal('${item.id}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteMaterialEntry('${item.id}', '${item.modelName} - ${item.batchNo}')">Delete</button></td></tr>`;
            });
            reportTableBody.innerHTML = tableHtml;
        }
        
        async function deleteMaterialEntry(docId, modelInfo) { if (confirm(`Are you sure you want to permanently delete "${modelInfo}"?`)) { db.collection('materials').doc(docId).delete().then(() => { alert('Entry deleted successfully!'); fetchAllMaterialsAndRenderReport(); }).catch((error) => alert('Error deleting entry: ' + error)); } }

        function openEditMaterialModal(docId) {
            const material = allMaterialsData.find(m => m.id === docId);
            if (material) {
                document.getElementById('edit-material-id').value = docId; document.getElementById('edit-model-name').value = material.modelName; document.getElementById('edit-batch-no').value = material.batchNo; document.getElementById('edit-color').value = material.color; document.getElementById('edit-target-qty').value = material.targetQty || 0; document.getElementById('edit-in-hand-qty').value = material.inHandQty || 0; document.getElementById('edit-packing-sent-qty').value = material.packingSentQty || 0; document.getElementById('edit-fail-qty').value = material.failQty || 0; document.getElementById('edit-faulty-qty').value = material.faultyQty || 0;
                document.getElementById('editMaterialModal').style.display = 'block';
            }
        }
        
        async function updateMaterial(event) {
            event.preventDefault();
            const docId = document.getElementById('edit-material-id').value;
            const updatedData = { modelName: document.getElementById('edit-model-name').value, batchNo: document.getElementById('edit-batch-no').value, color: document.getElementById('edit-color').value, targetQty: Number(document.getElementById('edit-target-qty').value), inHandQty: Number(document.getElementById('edit-in-hand-qty').value), packingSentQty: Number(document.getElementById('edit-packing-sent-qty').value), failQty: Number(document.getElementById('edit-fail-qty').value), faultyQty: Number(document.getElementById('edit-faulty-qty').value), };
            try {
                await db.collection('materials').doc(docId).update(updatedData);
                alert('Product data updated successfully!'); closeModal('editMaterialModal'); fetchAllMaterialsAndRenderReport(); loadDashboardData();
            } catch (error) { alert('Failed to update: ' + error.message); }
        }
        
        async function fetchPackingSendReport() {
            const reportTableBody = document.getElementById('packing-report-table-body');
            reportTableBody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;
            try {
                const snapshot = await db.collection('packing_sends').orderBy('sentAt', 'desc').get();
                allPackingSendData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPackingSendReport(allPackingSendData);
            } catch (error) { console.error("Error loading packing send report:", error); reportTableBody.innerHTML = `<tr><td colspan="6">Failed to load data.</td></tr>`; }
        }
        
        function renderPackingSendReport(data) {
            const reportTableBody = document.getElementById('packing-report-table-body');
            let tableHtml = '';
            if (data.length === 0) { reportTableBody.innerHTML = `<tr><td colspan="6">No data found.</td></tr>`; return; }
            data.forEach(item => {
                const sentDate = item.sentAt ? item.sentAt.toDate().toLocaleString('en-US') : 'N/A';
                tableHtml += `<tr><td>${sentDate}</td><td>${item.modelName}</td><td>${item.batchNo || 'N/A'}</td><td>${item.color}</td><td>${item.quantity}</td><td class="action-buttons"><button class="btn btn-sm btn-warning" onclick="openEditPackingSendModal('${item.id}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deletePackingSendEntry('${item.id}')">Delete</button></td></tr>`;
            });
            reportTableBody.innerHTML = tableHtml;
        }

        function openEditPackingSendModal(docId) {
            const entry = allPackingSendData.find(p => p.id === docId);
            if (entry) {
                document.getElementById('edit-packing-send-id').value = docId; document.getElementById('edit-packing-qty').value = entry.quantity;
                document.getElementById('editPackingSendModal').style.display = 'block';
            }
        }

        async function updatePackingSendEntry(event) {
            event.preventDefault();
            const docId = document.getElementById('edit-packing-send-id').value, newQuantity = Number(document.getElementById('edit-packing-qty').value);
            try {
                await db.collection('packing_sends').doc(docId).update({ quantity: newQuantity });
                alert('Entry updated successfully!'); closeModal('editPackingSendModal'); fetchPackingSendReport();
            } catch (error) { alert('Failed to update entry: ' + error.message); }
        }
        
        async function deletePackingSendEntry(docId) { if (confirm("Are you sure?")) { try { await db.collection('packing_sends').doc(docId).delete(); alert("Entry deleted."); fetchPackingSendReport(); } catch (error) { alert("Failed to delete: " + error.message); } } }

        async function loadDashboardData() {
            try {
                const [usersSnapshot, materialsSnapshot] = await Promise.all([db.collection('users').get(), db.collection('materials').get()]);
                let totalTargetQty = 0, totalProduction = 0, totalFail = 0;
                materialsSnapshot.forEach(doc => {
                    const data = doc.data();
                    totalTargetQty += (data.targetQty || 0); totalProduction += (data.inHandQty || 0) + (data.packingSentQty || 0); totalFail += (data.faultyQty || 0) + (data.failQty || 0);
                });
                document.getElementById('total-users').textContent = usersSnapshot.size; document.getElementById('total-target-qty').textContent = totalTargetQty; document.getElementById('total-production').textContent = totalProduction; document.getElementById('total-fail').textContent = totalFail;
            } catch (error) { console.error("Error loading dashboard data:", error); }
        }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function initializeModalListeners() {
            document.querySelectorAll('.modal').forEach(modal => {
                const span = modal.querySelector(".close-button");
                if (span) span.onclick = () => { modal.style.display = "none"; };
            });
            window.onclick = (event) => { document.querySelectorAll('.modal').forEach(modal => { if (event.target == modal) modal.style.display = "none"; }); };
            const addUserBtn = document.getElementById("addUserBtn");
            if(addUserBtn) addUserBtn.onclick = () => {
                openUserModal(false);
            };
        }
    </script>
</body>
</html>
